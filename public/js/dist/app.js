var Application=new Marionette.Application;Application.addRegions({mainRegion:"#main"}),Application.View={Layout:{},Composite:{},Collection:{},Item:{}},Application.Collection={},Application.Router={},Application.Model={},Application.Service={},Application.Controller={},Application.addInitializer(function(){Parse.initialize("tQwka3iy4tadatRg4ZPMmWwiR6W5ChAoMTfSkQbS","vPBf8a9VEX4FU4yRz2tsvYhlTnvj8hAuFIhmwZfr"),Parse.FacebookUtils.init({appId:"1436222829994519",channelUrl:"http://digital-memory.app.dev/channel.html",cookie:!0,xfbml:!0})}),Application.addInitializer(function(){Application.router=new Application.Router.Default}),Application.addInitializer(function(){Backbone.history.start()}),$(window).load(function(){Application.start()}),Application.View.Item.Activity=Backbone.Marionette.ItemView.extend({className:"activity"}),Application.View.Item.Login=Backbone.Marionette.ItemView.extend({template:JST.login,className:"mainbg",initialize:function(){},events:{"click .login":"login"},login:function(a){a.preventDefault(),Parse.FacebookUtils.logIn("email",{success:function(){window.location.hash="/start"},error:function(){console.log("error")}})}}),Application.View.Item.Map=Backbone.Marionette.ItemView.extend({className:"map",template:JST.map,markers:[],events:{"click .tab":"toggleTab"},initialize:function(){this.location=this.options.location,this.listenTo(this.location,"change",this.renderUser),this.listenTo(this.collection,"sync",this.renderActivities),this.listenTo(this.collection,"add",this.renderActivity),this.on("show",this.renderMap),$(".tab-map").addClass("active")},renderActivity:function(a){var b=a.get("location");if(void 0!==b){var c=new google.maps.LatLng(b.get("location").latitude,b.get("location").longitude),d=new google.maps.Marker({position:c,map:this.map,title:b.get("name"),icon:"img/venue.png"});this.markers.push(d);var e=this.markers.length;if(1===e)return void console.log("return");var f=new google.maps.Polyline({path:[this.markers[e-2].getPosition(),this.markers[e-1].getPosition()],geodesic:!0,strokeColor:"#FFFFFF",strokeOpacity:.8,strokeWeight:2});f.setMap(this.map)}},onDomRefresh:function(){$(".tab-map").addClass("active")},toggleTab:function(a){var b=$(a.currentTarget).data("type");$(".tab").removeClass("active"),$(a.currentTarget).addClass("active"),"map"===b?Application.router.navigate("/map",!0):"timeline"===b&&Application.router.navigate("/timeline",!0)},renderActivities:function(){void 0!==this.map&&0!==this.collection.length&&(this.collection.forEach(this.renderActivity,this),console.log(this.collection.length))},renderUser:function(){if(void 0!==this.map&&null!==this.location.get("latitude")){var a=new google.maps.LatLng(this.location.get("latitude"),this.location.get("longitude"));void 0===this.marker&&(this.marker=new google.maps.Marker({map:this.map,title:"Your Location",icon:"img/man.png"})),this.marker.setPosition(a),this.map.setCenter(a)}},renderMap:function(){var a=[{elementType:"geometry.fill",stylers:[{saturation:-98}]},{featureType:"road",stylers:[{color:"#36393d"},{visibility:"simplified"}]},{featureType:"landscape",stylers:[{color:"#3f4248"}]},{elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit.station",stylers:[{visibility:"off"}]},{}],b={zoom:16,center:new google.maps.LatLng(51.507222,-.1275),styles:a,disableDefaultUI:!0};this.map=new google.maps.Map(this.$el.find("#map-canvas").get(0),b),this.renderUser(),this.renderActivities()}}),Application.View.Item.Start=Backbone.Marionette.ItemView.extend({template:JST.start,className:"mainbg m-start",events:{"click #start":"start"},start:function(){return Application.router.navigate("/timeline",!0)}}),Application.View.Item.TimelineActivity=Backbone.Marionette.ItemView.extend({className:"timeline-activity moment",tagName:"li",template:JST.timelineItem,initialize:function(){console.log(this.model)},renderActivities:function(){void 0!==this.map&&0!==this.collection.length&&this.collection.forEach(this.renderActivity,this)}}),Application.View.Item.Timeline=Backbone.Marionette.ItemView.extend({template:JST.timeline,initialize:function(){console.log(this.collection)},events:{"click .tab":"toggleTab"},onDomRefresh:function(){$(".tab-timeline").addClass("active")},toggleTab:function(a){var b=$(a.currentTarget).data("type");$(".tab").removeClass("active"),$(a.currentTarget).addClass("active"),"map"===b?Application.router.navigate("/map",!0):"timeline"===b&&Application.router.navigate("/timeline",!0)}}),Application.View.Collection.Activities=Backbone.Marionette.CollectionView.extend({className:"activities",childView:Application.View.Item.Activity}),Application.View.Collection.Timeline=Backbone.Marionette.CompositeView.extend({template:JST.timeline,childView:Application.View.Item.TimelineActivity,childViewContainer:".times",className:"timeline-container",events:{"click .tab":"toggleTab"},initialize:function(){},onDomRefresh:function(){var a=this;$(".tab-timeline").addClass("active"),$(".time").text(this.calculateCurrentTime()),setInterval(function(){$(".time").text(a.calculateCurrentTime())},1e3)},calculateCurrentTime:function(){var a=new Date,b=a.getHours()+":"+a.getMinutes()+":"+a.getSeconds();return b},toggleTab:function(a){var b=$(a.currentTarget).data("type");$(".tab").removeClass("active"),$(a.currentTarget).addClass("active"),"map"===b?Application.router.navigate("/map",!0):"timeline"===b&&Application.router.navigate("/timeline",!0)}}),Application.Model.Activity=Parse.Object.extend({className:"Activity",toJSON:function(){var a=_.clone(this.attributes);return a.createdAt=this.createdAt,a.updatedAt=this.updatedAt,a.location=a.location?this.get("location").toJSON():{name:""},a}}),Application.Model.Location=Parse.Object.extend({className:"Location",defaults:{latitude:null,longitude:null},watchInterval:null,fetch:function(a){function b(a){var b=a.coords.latitude,c=a.coords.longitude,e={latitude:b,longitude:c};this.set(e),d.resolve(e)}function c(a){d.reject(a)}var d=new jQuery.Deferred,e=d.promise();return a=a||(a={}),a.success&&e.done(a.success),a.error&&e.fail(a.error),a.complete&&e.always(a.complete),navigator.geolocation.getCurrentPosition(_.bind(b,this),_.bind(c,this)),e},watch:function(a){this.watchInterval=setInterval(_.bind(this.fetch,this),a)},unwatch:function(){clearInterval(this.watchInterval)}}),Application.Model.User=Parse.Object.extend({className:"User"}),Application.Collection.Activities=Parse.Collection.extend({className:"Activity",model:Application.Model.Activity}),Application.Collection.Locations=Parse.Collection.extend({className:"Location",model:Application.Model.Location,initialize:function(a){a.location&&(console.log(a.location),this.location=a.location)},closest:function(a){var b=new google.maps.LatLng(this.location.get("latitude"),this.location.get("longitude")),c=null;return this.forEach(function(d){var e=d.get("location");if(void 0!==e){var f=e.latitude,g=e.longitude,h=new google.maps.LatLng(f,g),i=google.maps.geometry.spherical.computeDistanceBetween(b,h);d.set("distance",i),i>a||(null===c&&(c=d),i<c.get("distance")&&(c=d))}}),c}}),Application.Controller.Main=Marionette.Controller.extend({index:function(){Parse.User.current()?Application.router.navigate("/start",!0):Application.router.navigate("/login",!0)},login:function(){var a=new Application.View.Item.Login;Application.mainRegion.show(a)},start:function(){if(!Parse.User.current())return Application.router.navigate("/login",!0);var a=new Application.View.Item.Start;Application.mainRegion.show(a)},map:function(){if(!Parse.User.current())return Application.router.navigate("/login",!0);var a=this.options.location,b=this.options.activities,c=new Application.Model.Activity,d=new Application.View.Item.Map({collection:b,location:a,model:c});Application.mainRegion.show(d)},timeline:function(){if(!Parse.User.current())return Application.router.navigate("/login",!0);var a=this.options.location,b=this.options.activities,c=new Application.Model.Activity,d=new Application.View.Collection.Timeline({collection:b,location:a,model:c});Application.mainRegion.show(d)}}),Application.Router.Default=Backbone.Marionette.AppRouter.extend({initialize:function(){function a(){if(!(++i<5)){if(null==h){var a=f.at(0);h=a?a.get("location"):null}var c=g.closest(100);null!=c&&(h&&c.get("name")===h.get("name")||(h=c,b(c)))}}function b(a){var b=new Application.Model.Activity;b.set("user",d),b.set("location",a),b.save().then(c)}function c(a){f.add(a)}var d=Parse.User.current(),e=new Application.Model.Location,f=new Application.Collection.Activities;f.query=new Parse.Query(Application.Model.Activity),f.query.include(["location","user"]),f.query.equalTo("user",d);var g=new Application.Collection.Locations({location:e}),h=null,i=0;e.fetch().then(a),g.fetch().then(a),f.fetch().then(a),f.on("sync",a),e.on("change",a),e.watch(5e3);var j={location:e,locations:g,activities:f};this.processAppRoutes(new Application.Controller.Main(j),{"":"index",login:"login",start:"start",map:"map",timeline:"timeline"})}}),Application.Service.Location=function(){},_.extend(Application.Service.Location.prototype,Backbone.Events,{});
//# sourceMappingURL=app.js.map